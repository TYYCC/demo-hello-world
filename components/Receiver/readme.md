# Receiver 组件

该组件是 ESP32 接收端的核心模块，提供完整的通信、控制和状态管理功能。

## 主要功能

### 1. 通信协议
- **TCP通信协议**：基于自定义帧格式的可靠通信
- **心跳机制**：独立的心跳客户端，确保连接稳定性
- **遥测传输**：实时遥测数据传输和处理
- **协议解析**：完整的帧解析和CRC校验

### 2. 网络管理
- **WiFi配对管理**：自动扫描和连接目标网络
- **事件驱动架构**：基于WiFi连接状态的TCP任务管理
- **自动重连**：网络断开时的自动重连机制

### 3. 状态指示
- **LED状态管理**：多种LED指示模式（呼吸、闪烁、常亮等）
- **优先级系统**：支持不同优先级的状态指示
- **自定义样式**：可配置的LED颜色和效果

### 4. 数据处理
- **JPEG流编码**：使用ESP-ADF进行实时图像编解码
- **设置管理**：系统配置的持久化存储
- **终端命令**：调试和配置命令接口

### 5. 通信接口
- **USB设备模式**：CDC-ACM串口通信
- **SPI从设备**：高速SPI数据传输
- **TCP网络通信**：基于WiFi的网络通信

## 通信方式

### TCP网络通信

#### 心跳客户端 (tcp_hb)
- **端口**：7878（默认）
- **间隔**：30秒心跳间隔
- **超时**：90秒心跳超时
- **重连**：5秒自动重连间隔
- **功能**：维持连接活跃状态，监控网络健康

#### 遥测客户端 (tcp_telemetry)
- **端口**：6667（默认）
- **数据**：电压、电流、姿态角、高度等
- **频率**：1Hz遥测数据发送
- **缓冲**：1024字节接收缓冲区
- **功能**：实时遥测数据传输和接收

### USB从设备（CDC-ACM）
- **引脚**：`USB_DP`=IO20, `USB_DM`=IO19（ESP32-S3固定）
- **供电**：建议通过USB VBUS 5V供电；板载3V3稳压
- **识别**：作为串口设备出现（CDC-ACM）
- **协议**：使用`tcp_common_protocol.h`帧格式
- **构建**：需启用`tinyusb`组件依赖

### SPI从设备
- **模式**：SPI从设备模式
- **速度**：高速数据传输
- **用途**：与主控设备的高速数据交换

## 🔧 编译配置

在顶层的[CMakeLists.txt](../../CMakeLists.txt)文件中设置：
```cmake
set(EN_RECEIVER_MODE ON)
```

## 配置参数

### WiFi配对配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| scan_interval_ms | 5000 | WiFi扫描间隔（毫秒） |
| task_priority | 3 | 任务优先级 |
| task_stack_size | 4096 | 任务栈大小 |
| connection_timeout_ms | 10000 | 连接超时时间（毫秒） |
| target_ssid_prefix | "ESP32_Terminal_" | 目标SSID前缀 |
| default_password | "12345678" | 默认密码 |

### LED管理器配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| led_count | 1 | LED数量 |
| task_priority | 2 | 任务优先级 |
| task_stack_size | 4096 | 任务栈大小 |
| queue_size | 8 | 请求队列大小 |

### TCP客户端配置

| 参数 | 心跳客户端默认值 | 遥测客户端默认值 | 说明 |
|------|------------------|------------------|------|
| 默认端口 | 7878 | 6667 | 服务器端口 |
| 心跳间隔 | 30000ms | - | 心跳发送间隔 |
| 重连间隔 | 5000ms | 5000ms | 自动重连间隔 |
| 发送超时 | 5000ms | 5000ms | 发送超时时间 |
| 接收超时 | 1000ms | 1000ms | 接收超时时间 |

## 引脚分配

### A 面（信号为主，给高速留"地护栏"）

| 引脚 | 功能 | 说明 |
|------|------|------|
| A1 | GND | |
| A2 | GND | |
| A3 | +5V | USB/VBUS 或备用 5V |
| A4 | GND | 可改作 USB_ID/OTG，默认 GND 做屏蔽 |
| A5 | GND | USB 护栏 |
| A6 | USB_D+ | |
| A7 | USB_D− | A5/A8 做护栏 |
| A8 | GND | USB 护栏 |
| A9 | GND | SCLK 护栏 |
| A10 | SPI_SCLK | 两侧 A9/A11 为 GND |
| A11 | GND | SCLK 护栏 |
| A12 | SPI_MOSI | |
| A13 | GND | MOSIx 护栏 |
| A14 | SPI_MISO | |
| A15 | GND | MISO 护栏 |
| A16 | SPI_CS0 | |
| A17 | +3V3 | 主逻辑电源 |
| A18 | GND | |

### B 面（PWM+CS 分区，穿插接地）

| 引脚 | 功能 | 说明 |
|------|------|------|
| B1 | GND | |
| B2 | GND | |
| B3 | +5V | 与 A3 并联提高承载 |
| B4 | SPI_CS1 | 或备用 CS/INT |
| B5 | PWM1 | |
| B6 | GND | |
| B7 | PWM2 | |
| B8 | PWM3 | |
| B9 | GND | |
| B10 | PWM4 | |
| B11 | PWM5 | |
| B12 | GND | |
| B13 | PWM6 | |
| B14 | PWM7 | |
| B15 | GND | |
| B16 | PWM8 | |
| B17 | +3V3 | 与 A17 并联 |
| B18 | GND | |

