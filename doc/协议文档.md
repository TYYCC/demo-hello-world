在下文中，地面站直接指定为本机。

---

# ESP32 TCP 遥控 + 遥测协议文档

## 1. 数据帧通用格式

```
| 帧头 (2B) | 长度 (1B) | 类型 (1B) | 负载 (NB) | CRC16 (2B) |
```

* **帧头**：固定 `0xAA 0x55`
* **长度**：从 `类型` 到 `CRC16` 的总长度（字节数）
* **类型**：帧类型（见下文）
* **负载**：帧内容（命令/遥测数据/心跳/扩展命令）
* **CRC16**：对 `长度 + 类型 + 负载` 做校验

---

## 2. 遥控命令（地面站 → ESP32）

### 类型：`0x01`（遥控命令）

```
| 通道数量 (1B) | 通道1 (2B) | 通道2 (2B) | ... | 通道N (2B) |
```

* **通道数量**：表示本帧携带通道数 N
* **通道值**：0\~1000（0→最小，500→中位，1000→最大）

  * CH1 通常为油门
  * CH2/CH3/CH4 可对应方向/舵机/辅助功能
  * 最大支持八通道

#### 示例（4通道遥控）

```
AA 55 0B 01 04 03E8 01F4 01F4 01F4 CRC
```

---

## 3. 遥测数据（ESP32 → 地面站）

### 类型：`0x02`（遥测数据）

```
| 电压 (2B, mV) | 电流 (2B, mA) | Roll (2B, 0.01°) | Pitch (2B) | Yaw (2B) | 高度 (4B, cm) |
```

* **电压**：单位 mV
* **电流**：单位 mA
* **姿态角 Roll/Pitch/Yaw**：单位 0.01°
* **高度**：单位 cm

#### 示例

```
AA 55 0D 02 0BB8 00C8 0000 0005 012C 00002710 CRC
```

* 电压 3.0V
* 电流 200mA
* Roll 0.00°
* Pitch 0.05°
* Yaw 30.0°
* 高度 100m

---

## 4. 心跳包 / 保活（ESP32 → 地面站）

### 类型：`0x03`（心跳包）

```
| 设备状态 (1B) |
```

* 0x00 → 空闲
* 0x01 → 正常运行
* 0x02 → 错误

#### 示例

```
AA 55 04 03 01 CRC
```

---

## 5. 扩展命令（地面站 → ESP32）

### 类型：`0x04`（扩展命令）

```
| 命令ID (1B) | 参数长度 (1B) | 参数 (NB) |
```

#### 常用命令ID

| 命令ID | 名称        | 参数    | 说明              |
| ---- | --------- | ----- | --------------- |
| 0x10 | 设置 PWM 频率 | 2B Hz | 设置输出PWM频率       |
| 0x11 | 模式切换      | 1B    | 0=手动，1=自动       |
| 0x12 | 校准传感器     | 0B    | 无参数，启动传感器校准     |
| 0x13 | 请求遥测      | 0B    | ESP32立刻上传一次遥测数据 |
| 0x14 | 灯光控制      | 1B    | 0=关，1=开         |

#### 示例

```
AA 55 06 04 11 01 01 CRC
```

* 切换模式到自动

---


---

## 6. TCP 注意事项

* TCP 无消息边界，需要按 **帧头 + 长度** 做拆包/粘包处理
* CRC16 对数据完整性校验，可选择 **Modbus CRC16** 或 **XMODEM CRC16**
* 推荐 ESP32 和地面端都使用 **环形缓冲区** 解析数据

---

这个协议可以满足：

* **遥控**（上下左右 + 油门 + 扩展通道）
* **遥测**（姿态、电压、电流、高度）
* **心跳和状态监控**
* **扩展功能**（模式切换、参数设置、灯光等）

NONONO，油门和方向是两个滑动条，然后还是和遥测状态在同一排。滑动条不是有一个点吗，放在中间 
┌─────────────────────────┐ 
│ 返回     遥控器     设置 │ 
├─────────────────────────┤ 
│ 油门方向     │ 遥测状态   │ 
│ 油门: ──●── │ 电压:12.1V │
| 方向: ──●── | 电流: 1.3A |
├─────────────────────────┤ 
│ 姿态显示                 │ 
│ Roll / Pitch / Yaw │ 
│ 高度 / GPS │ │ 高度: 150m │ 
│ GPS: 35.1234° │ 
├─────────────────────────┤ 
│ 阀相                    │ 
└─────────────────────────┘
---
