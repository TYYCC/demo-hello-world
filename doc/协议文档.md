在下文中，地面站直接指定为本机。

---

# ESP32 TCP 传输协议定义

## 1. 数据帧通用格式

```
| 帧头 (2B) | 长度 (1B) | 类型 (1B) | 负载 (NB) | CRC16 (2B) |
```

* **帧头**：固定 `0xAA 0x55`
* **长度**：从 `类型` 到 `CRC16` 的总长度（字节数）
* **类型**：帧类型（见下文）
* **负载**：帧内容（命令/遥测数据/心跳/扩展命令）
* **CRC16**：对 `长度 + 类型 + 负载` 做校验

---

## 2. 遥控命令（地面站 → ESP32）

### 类型：`0x01`（遥控命令）

```
| 通道数量 (1B) | 通道1 (2B) | 通道2 (2B) | ... | 通道N (2B) |
```

* **通道数量**：表示本帧携带通道数 N
* **通道值**：0\~1000（0→最小，500→中位，1000→最大）

  * CH1 通常为油门
  * CH2/CH3/CH4 可对应方向/舵机/辅助功能
  * 最大支持八通道

#### 示例（4通道遥控）

```
AA 55 0B 01 04 03E8 01F4 01F4 01F4 CRC
```

---

## 3. 遥测数据（ESP32 → 地面站）

### 类型：`0x02`（遥测数据）

```
| 电压 (2B, mV) | 电流 (2B, mA) | Roll (2B, 0.01°) | Pitch (2B) | Yaw (2B) | 高度 (4B, cm) |
```

* **电压**：单位 mV
* **电流**：单位 mA
* **姿态角 Roll/Pitch/Yaw**：单位 0.01°
* **高度**：单位 cm

#### 示例

```
AA 55 0D 02 0BB8 00C8 0000 0005 012C 00002710 CRC
```

* 电压 3.0V
* 电流 200mA
* Roll 0.00°
* Pitch 0.05°
* Yaw 30.0°
* 高度 100m

---

## 4. 心跳包 / 保活（ESP32 → 地面站）

### 类型：`0x03`（心跳包）

```
| 设备状态 (1B) |
```

* 0x00 → 空闲
* 0x01 → 正常运行
* 0x02 → 错误

#### 示例

```
AA 55 04 03 01 CRC
```

---

## 5. 扩展命令（地面站 → ESP32）

### 类型：`0x04`（扩展命令）

```
| 命令ID (1B) | 参数长度 (1B) | 参数 (NB) |
```

#### 常用命令ID

| 命令ID | 名称        | 参数    | 说明              |
| ---- | --------- | ----- | --------------- |
| 0x10 | 设置 PWM 频率 | 2B Hz | 设置输出PWM频率       |
| 0x11 | 模式切换      | 1B    | 0=手动，1=自动       |
| 0x12 | 校准传感器     | 0B    | 无参数，启动传感器校准     |
| 0x13 | 请求遥测      | 0B    | ESP32立刻上传一次遥测数据 |
| 0x14 | 灯光控制      | 1B    | 0=关，1=开         |

#### 示例

```
AA 55 06 04 11 01 01 CRC
```

* 切换模式到自动

---


---

## 6. 特殊命令

```
| 命令ID (1B) | 参数长度 (1B) | 参数 (NB) |
```

### 类型：`0x05`

| 命令ID | 名称   | 参数    | 说明     |
| ---- | --------- | ----- | --------------- |
| 0x11 | STA_IP地址      | 4B    | STA_IP地址   |
| 0x12 | STA_IP密码      | 4B    | STA_IP密码   |
| 0x15 | 重启      | 0B    | 无参数，重启ESP32       |

## 7.图传图像设置(要求返回)

### 类型：`0x06`（图传）

| 命令ID | 名称   | 参数    | 说明     |
| ---- | --------- | ----- | --------------- |
| 0x20 | JPEG编码质量      | 1B    | 0~100，0为最差，100为最佳   |
| 0x21 | JPEG图像宽度      | 2B    | 图像宽度   |
| 0x22 | JPEG图像高度      | 2B    | 图像高度   |
| 0x23 | 是否启用JPEG编码      | 1B    | 0=不启用，1=启用，默认关闭  |
| 0x24 | 是否使用UDP      | 1B    | 0=不使用，1=使用，为0时默认使用TCP进行传输  |
| 0x25 | UDP端口号      | 2B    | UDP端口号   |

## 8.返回命令要求

### 类型：`0x07`（ACK）

目前只有图传图像设置结果需要返回，其他命令都不需要返回。

### 返回命令

| 命令ID | 名称   | 参数    | 说明     |
| ---- | --------- | ----- | --------------- |
| 0x26 | 图传图像设置结果      | 1B    | 0=失败，1=成功   |
| 0x27 | JPEG编码是否打开的结果      | 1B    | 0=失败，1=成功   |
| 0x28 | 是否使用UDP的结果      | 1B    | 0=失败，1=成功   |
| 0x2C | UDP端口号设置的结果      | 1B    | 0=失败，1=成功   |

#### 其他返回结果

|值|说明|
|---|---|
|0x02|参数无效|
|0x03|不支持的命令|
|0x04|执行超时|
|0x05|系统忙|

## 6. TCP 注意事项

* TCP 无消息边界，需要按 **帧头 + 长度** 做拆包/粘包处理
* CRC16 对数据完整性校验，可选择 **Modbus CRC16** 或 **XMODEM CRC16**
* 推荐 ESP32 和地面端都使用 **环形缓冲区** 解析数据

---

这个协议可以满足：

* **遥控**（上下左右 + 油门 + 扩展通道）
* **遥测**（姿态、电压、电流、高度）
* **心跳和状态监控**
* **扩展功能**（模式切换、参数设置、灯光等）
* **设置**（JPEG编码、UDP传输）

# ESP32 TCP 图传传输协议定义

定义一个特殊协议用于在传输过程中的识别当前为什么数据流。使用了__attribute__((packed))保证内存对齐问题

|字节数|说明|固定值|
|---|---|---|
|sync_word|同步头/魔数，(Magic Number)，用于帧起始识别|0xAEBC1402|
|data_type|数据类型 (JPEG, LZ4, RAW)|参考数据类型常量|
|width|图片宽度||
|height|图片高度||
|data_len|后面跟随的数据负载长度|-|

数据类型常量(data_type)
|值|说明|
|---|---|
|0x01|JPEG编码|
|0x02|LZ4压缩|
|0x03|原始数据|

例如：

AEBC1402 01 F0 B4 00008789 ...

上述表中，0x01为JPEG编码，0x00008789(十进制34697字节)为数据负载长度,...代表数据
