# 终端命令与USB数据接收说明

本文档说明设备通过 USB CDC 和二进制协议接收电脑发送的数据时的行为、支持的终端命令、返回格式与使用方法。

## 一、数据接收与判别逻辑

设备支持“二进制协议帧”和“ASCII 文本行命令”两种输入，自动判别：

- 当接收缓冲区前两个字节为 0xAA 0x55（FRAME_HEADER）时，按自定义二进制协议解析。
- 否则，按 ASCII 文本行命令解析（以 \r、\n 或 \r\n 分隔的行）。
- 对于不完整的帧或未结束的半行，将暂存于接收缓冲区，等待后续字节到来，不会丢包。

二进制协议帧格式参见 components/Receiver/inc/tcp_protocol.h：
- 帧头：0xAA55（大端）
- 长度：1 字节（表示“类型 + 负载”的总长度）
- 类型：1 字节
- 负载：长度 - 1
- CRC16：2 字节（Modbus，针对“长度+类型+负载”小端存储）

当类型为 FRAME_TYPE_EXTENDED_CMD (0x04) 且 cmd_id=0x01 时，表示“文本终端命令”，其负载布局：
- cmd_id: 1 字节（固定 0x01）
- param_len: 1 字节
- params: param_len 字节（ASCII 命令行，不含行结束符）

## 二、USB 终端命令

以下命令在 ASCII 文本模式或通过扩展命令(cmd_id=0x01)下均可使用。每条命令以回车/换行结束发送。

- help 或 ?
  - 描述：显示可用命令
  - 返回示例：
    可用命令:
      help                - 显示帮助
      heap                - 打印空闲堆内存
      tasks               - 打印任务数量
      version             - 打印IDF版本
      echo <text>         - 回显文本
      jpegq <0-100>       - 设置JPEG质量(需要模块支持)

- heap
  - 描述：打印当前可用堆内存（字节）
  - 返回示例：
    Free heap: 292304 bytes

- tasks
  - 描述：打印当前任务数量
  - 返回示例：
    Tasks: 26

- version
  - 描述：打印 ESP-IDF 版本字符串
  - 返回示例：
    IDF: v5.2.1

- echo <text>
  - 描述：原样回显文本（保留原始大小写与空格）
  - 示例：发送：
    echo Hello World
    返回：
    Hello World

- jpegq <0-100>
  - 描述：设置 JPEG 质量，范围 0~100。
  - 返回示例：
    设置JPEG质量=75, 成功
    或
    设置JPEG质量=75, 未生效(需模块支持)
  - 说明：若 JPEG 模块未提供“运行时修改质量”的覆盖实现，将提示“未生效”。

返回均以 CRLF("\r\n") 作为行结束符，便于串口终端显示。

## 三、如何使用

1) 连接方式
- 通过 USB 线连接主机与设备，设备会枚举为 USB CDC 串口（Windows 下为 COMx，macOS 为 /dev/tty.usbmodem*）。
- 终端/上位机串口参数：USB CDC 对波特率不敏感，但建议设为 115200 8N1；行结束符建议使用 CRLF（或自动将 Enter 发送为 \r\n）。

2) 发送文本命令
- 打开串口终端，输入命令并按回车（\r 或 \n 或 \r\n 皆可）。
- 例如输入：help 回车，即可得到命令列表。

3) 通过二进制协议发送扩展命令（可选）
- 构造类型为 0x04 的帧，cmd_id=0x01，params 内容为 ASCII 命令行字节（不带行结束符）。
- 设备将把该行转交给终端命令解析器，返回文本通过 USB CDC 输出。

4) 典型问题
- 无回显：确认 USB CDC 已连接（终端打开后 DTR/RTS 置位），设备日志会显示连接状态。
- 命令无响应：检查是否发送了行结束符；若通过二进制协议发送，检查 CRC 是否正确。

## 四、实现要点（供开发参考）

- usb_device_receiver.c
  - parse_and_dispatch()：
    - 若缓冲区以 0xAA 0x55 开头，循环解析完整二进制帧，不完整部分保留到全局解析缓冲；
    - 否则按文本模式拆分行并调用 cmd_terminal_handle_line()；未完成的半行保留。
  - cmd_terminal_write()：将一行文本写回主机，并追加 CRLF。

- cmd_terminal.c
  - 新增 cmd_terminal_handle_line(const char* line) 接口：将一行文本复制到可修改缓冲后调用内部解析函数；
  - 支持命令：help/heap/tasks/version/echo/jpegq；
  - 允许模块通过强符号覆盖 cmd_terminal_write() 与 cmd_terminal_set_jpeg_quality()。

- main.c
  - 以 EN_RECEIVER_MODE 分支启动 USB 接收任务；不需要额外改动即可使用终端命令。

如需扩展更多命令，可在 cmd_terminal.c 的 handle_text_command() 中添加分支即可。