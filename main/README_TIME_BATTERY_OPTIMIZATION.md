# 时间和电池电量显示优化

## 概述
本次优化主要解决了以下问题：
1. 每次回到主界面时间都归零的问题
2. 时间和电池电量的后台更新机制
3. 电池电量显示格式和颜色优化

## 主要改进

### 1. 后台管理模块 (Background Manager)
- **文件位置**: `main/background_manager.c` 和 `main/inc/background_manager.h`
- **功能**: 统一管理时间和电池电量的后台更新

#### 时间管理
- 使用RTC时钟进行时间更新（每分钟更新一次）
- WiFi仅用于校准，每小时同步一次
- 只显示小时和分钟，不显示秒数
- 时间格式：`HH:MM`

#### 电池管理
- 每5秒更新一次电池电量
- 显示格式：只显示数字，不显示百分号
- 颜色规则：
  - 30%以下：红色 (`#FF0000`)
  - 30%以上：黑色 (`#000000`)

### 2. UI界面优化
- **文件位置**: `main/UI/ui_main.c`
- **更新频率**: 每分钟检查一次后台更新
- **显示逻辑**: 前台只负责显示，后台负责数据更新

### 3. 任务管理优化
- **文件位置**: `main/task_init.c`
- 后台管理任务在系统启动时自动初始化
- 电池监控任务改为日志记录功能

## 技术特点

### 线程安全
- 使用互斥锁保护共享数据
- 避免UI线程和后台任务的数据竞争

### 资源优化
- 减少WiFi使用频率（仅用于时间校准）
- 优化更新频率，减少系统负载

### 用户体验
- 时间连续性：不再出现归零问题
- 电池状态可视化：通过颜色直观显示电量状态
- 响应性：UI更新及时，无卡顿

## 配置参数

### 时间更新频率
- 后台更新：每分钟
- UI检查：每分钟
- WiFi同步：每小时

### 电池更新频率
- 后台更新：每5秒
- UI检查：每分钟

### 颜色阈值
- 红色警告：≤ 30%
- 正常显示：> 30%

## 使用方法

系统启动后会自动初始化后台管理模块，无需额外配置。时间和电池电量会在主界面顶部状态栏自动显示和更新。

## 日志输出

系统会输出以下日志信息：
- `BACKGROUND_MANAGER`: 后台管理相关日志
- `UI_MAIN`: UI更新相关日志
- `TASK_INIT`: 任务初始化日志

## 注意事项

1. 首次启动时时间从00:00开始计时
2. 需要WiFi连接才能进行时间校准
3. 电池颜色变化是实时的，无需重启
4. 后台管理任务运行在Core 0，UI任务运行在Core 1
